name: SNS-Service Deploy to EC2

on:
  push:
    branches: [ "dev", "deploy", "main" ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Backend (Gradle)
        run: |
          cd backend
          chmod +x gradlew
          ./gradlew clean build -x test --no-daemon

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/sns-backend
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-,format=short

      - name: Build & Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.dev
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/sns-backend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/sns-backend:buildcache,mode=max

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/sns-frontend
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-,format=short

      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./front
          file: ./front/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/sns-frontend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/sns-frontend:buildcache,mode=max

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME || 'ubuntu' }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 15m
          command_timeout: 15m
          script: |
            set -e
            
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            
            echo "ğŸš€ Starting deployment..."
            echo "ğŸ“ Deploy path: $DEPLOY_PATH"
            echo "ğŸ³ Docker username: $DOCKER_USERNAME"
            echo ""
            
            # ë””ë ‰í† ë¦¬ ìƒì„± ë° ì´ë™
            mkdir -p "$DEPLOY_PATH"/{front,backend}
            cd "$DEPLOY_PATH"
            
            # docker-compose.prod.yml íŒŒì¼ ìƒì„±
            echo "ğŸ“ Creating docker-compose.prod.yml..."
            cat > docker-compose.prod.yml << 'COMPOSEEOF'
            services:
              front:
                image: ${DOCKER_USERNAME}/sns-frontend:latest
                container_name: sns-frontend-prod
                ports:
                  - "3000:3000"
                env_file:
                  - front/.env.prod
                restart: unless-stopped
                healthcheck:
                  test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 60s
            
              back:
                image: ${DOCKER_USERNAME}/sns-backend:latest
                container_name: sns-backend-prod
                ports:
                  - "8080:8080"
                env_file:
                  - backend/.env.prod
                depends_on:
                  db:
                    condition: service_healthy
                restart: unless-stopped
                healthcheck:
                  test: ["CMD-SHELL", "curl -f http://localhost:8080/api/home || exit 1"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 90s
            
              db:
                image: mysql:8.0
                container_name: sns-mysql-prod
                env_file:
                  - backend/.env.prod
                ports:
                  - "3306:3306"
                volumes:
                  - mysql_data:/var/lib/mysql
                restart: unless-stopped
                healthcheck:
                  test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
                  interval: 5s
                  timeout: 10s
                  retries: 10
                  start_period: 30s
            
            volumes:
              mysql_data:
            COMPOSEEOF
            echo "âœ… docker-compose.prod.yml created"
            echo ""
            
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            echo "ğŸ” Checking environment files..."
            if [ ! -f "backend/.env.prod" ] || [ ! -f "front/.env.prod" ]; then
              echo "âŒ Error: Environment files are missing!"
              echo ""
              echo "Required files:"
              [ ! -f "backend/.env.prod" ] && echo "  âœ— backend/.env.prod"
              [ ! -f "front/.env.prod" ] && echo "  âœ— front/.env.prod"
              echo ""
              echo "Please create these files on EC2. See DEPLOYMENT.md for details."
              exit 1
            fi
            echo "âœ… Environment files found"
            echo ""
            
            # Docker Compose ëª…ë ¹ì–´ í™•ì¸
            if command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE_CMD="docker-compose"
            elif docker compose version &> /dev/null; then
              DOCKER_COMPOSE_CMD="docker compose"
            else
              echo "âŒ Error: docker-compose not found"
              exit 1
            fi
            
            echo "ğŸ³ Using: $DOCKER_COMPOSE_CMD"
            echo ""
            
            # ì´ë¯¸ì§€ Pull
            echo "â¬‡ï¸  Pulling latest images..."
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml pull
            echo ""
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            echo "ğŸ›‘ Stopping old containers..."
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml down
            echo ""
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo "ğŸš€ Starting new containers..."
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml up -d
            echo ""
            
            # ì´ˆê¸° ëŒ€ê¸°
            echo "â³ Waiting for containers to initialize..."
            sleep 20
            
            # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
            echo "ğŸ¥ Checking service health..."
            max_attempts=15
            attempt=0
            all_ready=false
            
            while [ $attempt -lt $max_attempts ]; do
              attempt=$((attempt + 1))
              
              # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
              running_count=$($DOCKER_COMPOSE_CMD -f docker-compose.prod.yml ps | grep -c "Up" || echo "0")
              
              # ì„œë¹„ìŠ¤ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
              backend_up=0
              front_up=0
              
              if timeout 5 curl -sf http://localhost:8080/api/home > /dev/null 2>&1; then
                backend_up=1
              fi
              
              if timeout 5 curl -sf http://localhost:3000 > /dev/null 2>&1; then
                front_up=1
              fi
              
              echo "[$attempt/$max_attempts] Running: $running_count/3 | Backend: $([ $backend_up -eq 1 ] && echo 'âœ…' || echo 'â³') | Frontend: $([ $front_up -eq 1 ] && echo 'âœ…' || echo 'â³')"
              
              # ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì ‘ê·¼ ê°€ëŠ¥í•˜ë©´ ì„±ê³µ
              if [ $backend_up -eq 1 ] && [ $front_up -eq 1 ]; then
                echo ""
                echo "âœ… All services are ready!"
                all_ready=true
                break
              fi
              
              # ìµœì†Œ 5ë²ˆ ì‹œë„ í›„, ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ë©´ ê³„ì† ì§„í–‰
              if [ $running_count -ge 3 ] && [ $attempt -ge 5 ]; then
                echo ""
                echo "âš ï¸  All containers are running. Services may still be initializing..."
                all_ready=true
                break
              fi
              
              sleep 10
            done
            
            echo ""
            echo "ğŸ“Š Final Status:"
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml ps
            echo ""
            
            if [ "$all_ready" = false ]; then
              echo "âš ï¸  Some services may not be fully ready yet."
              echo "ğŸ“‹ Recent logs:"
              $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml logs --tail=20
            fi
            
            # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
            echo ""
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h" || true
            
            echo ""
            echo "âœ… Deployment complete!"
